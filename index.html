<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Holi Bash 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- EmailJS Library - Required for real email delivery -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; overflow: hidden; background: #fdfdfd; user-select: none; }
        canvas { position: fixed; top: 0; left: 0; z-index: 1; cursor: crosshair; }
        #login-overlay, #admin-overlay { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        #login-overlay { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); }
        #admin-overlay { background: rgba(0,0,0,0.8); display: none; }
        .ui-layer { position: relative; z-index: 10; pointer-events: none; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; }
        .interactive { pointer-events: auto; }
        .vibrate { animation: vibrate 0.1s linear infinite; }
        @keyframes vibrate { 0%, 100% { transform: translate(0); } 25% { transform: translate(-2px, 2px); } 50% { transform: translate(2px, -2px); } }
        .gradient-text { background: linear-gradient(to right, #ff0055, #ffdd00, #00ffaa, #0088ff, #cc00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 400% 400%; animation: moveGradient 5s ease infinite; }
        @keyframes moveGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .color-swatch { width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; cursor: pointer; transition: all 0.2s; }
        .active-color { border: 3px solid #000; transform: scale(1.2); }
        .wish-popup { position: fixed; pointer-events: none; font-weight: 900; padding: 12px 24px; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 5; animation: floatUp 4s ease-out forwards; border-left: 5px solid; }
        @keyframes floatUp { 0% { transform: translateY(20px); opacity: 0; } 10% { transform: translateY(0); opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-100px); opacity: 0; } }
        
        .mode-btn { border: 2px solid transparent; transition: all 0.2s; }
        .mode-btn.active { border-color: black; background: black !important; color: white !important; transform: scale(1.05); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        .clear-btn {
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.2s;
            border: 1px solid #f1f5f9;
        }
        .clear-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .clear-btn:active { transform: translateY(0); }
    </style>
</head>
<body>

    <!-- On-screen Notification (Still kept for visual confirmation alongside real email) -->
    <div id="notification-box" class="interactive" style="position: fixed; top: 20px; right: 20px; z-index: 999; background: #1e293b; color: white; padding: 20px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); max-width: 300px; display: none;">
        <div class="flex justify-between items-start mb-2">
            <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Email Dispatched</span>
            <button onclick="this.parentElement.parentElement.style.display='none'" class="text-gray-400 text-xs">‚úï</button>
        </div>
        <p class="text-xs font-semibold leading-relaxed">Hi <span id="notif-name">User</span>! A passcode has been sent to your inbox.</p>
        <h3 id="notif-code" class="text-2xl font-black text-center my-3 text-green-400 tracking-widest">000000</h3>
        <p class="text-[9px] text-gray-400 italic text-center">Check your mail or use the code above.</p>
    </div>

    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center">
            <h2 class="text-3xl font-black gradient-text uppercase tracking-tighter">Team Holi Portal</h2>
            
            <div id="login-stage-email">
                <p class="text-gray-400 text-sm mb-6 mt-2">Enter your office email to begin</p>
                <form id="email-form" class="space-y-4">
                    <input type="email" id="user-email" required class="w-full px-5 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl outline-none focus:border-blue-500 font-semibold" placeholder="yourname@company.com">
                    <p id="email-error" class="text-red-500 text-[10px] font-bold hidden">Email not authorized. Use Admin Tools to add it first.</p>
                    <button type="submit" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-blue-700 transition-all uppercase tracking-widest">Get Passcode</button>
                </form>
            </div>

            <div id="login-stage-passcode" class="hidden" style="display: none;">
                <p class="text-gray-400 text-sm mb-4 mt-2">Enter the 6-digit code sent to <br><span id="target-email-display" class="text-blue-600 font-bold">...</span></p>
                <form id="passcode-form" class="space-y-4">
                    <input type="text" maxlength="6" id="user-passcode" required style="letter-spacing: 0.5em; text-align: center; font-weight: 900;" class="w-full px-5 py-4 bg-gray-50 border-2 border-gray-100 rounded-2xl outline-none focus:border-green-500 text-2xl" placeholder="000000">
                    <p id="passcode-error" class="text-red-500 text-xs font-bold hidden">Invalid Passcode.</p>
                    <button type="submit" class="w-full bg-green-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-green-700 transition-all uppercase tracking-widest">Login to Bash</button>
                    <button type="button" onclick="resetToEmail()" class="text-[10px] text-gray-400 font-black uppercase mt-4 hover:text-gray-600 transition">‚Üê Use different email</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-overlay">
        <div class="bg-white p-8 rounded-[2rem] w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-black">Admin Dashboard</h3>
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">Manage your authorized guest list</p>
                </div>
                <button onclick="toggleAdminPanel(false)" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full transition">‚úï</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 overflow-y-auto">
                <div class="bg-gray-50 p-5 rounded-3xl border border-gray-100">
                    <h4 class="text-xs font-black mb-4 uppercase text-gray-500 flex items-center gap-2">Individual Entry</h4>
                    <form id="admin-add-form" class="flex flex-col gap-3">
                        <input type="text" id="new-name" placeholder="Full Name" class="p-3 border rounded-xl text-sm font-semibold outline-none focus:border-blue-500" required>
                        <input type="email" id="new-email" placeholder="Work Email" class="p-3 border rounded-xl text-sm font-semibold outline-none focus:border-blue-500" required>
                        <select id="new-gender" class="p-2 border rounded-xl text-sm font-bold">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-3 rounded-xl font-bold text-sm hover:bg-blue-700">Add Employee</button>
                    </form>
                </div>

                <div class="bg-indigo-50 p-5 rounded-3xl border border-indigo-100">
                    <h4 class="text-xs font-black mb-1 uppercase text-indigo-500">Bulk Import</h4>
                    <p class="text-[10px] text-indigo-400 mb-3 font-bold uppercase">Format: Name, Email, Gender (one per line)</p>
                    <textarea id="bulk-import-text" class="w-full h-32 p-3 text-[11px] border rounded-2xl outline-none focus:border-indigo-400 font-mono" placeholder="John Doe, john@company.com, male"></textarea>
                    <button onclick="handleBulkImport()" class="w-full mt-3 bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm hover:bg-indigo-700">Import Guest List</button>
                    <div id="import-status" class="text-[10px] font-black mt-2 text-center hidden"></div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto space-y-2 pr-2 border-t pt-4" id="employee-list-admin"></div>
        </div>
    </div>

    <canvas id="holiCanvas"></canvas>

    <div class="ui-layer">
        <div class="flex justify-between items-start">
            <div class="card interactive bg-white/90 backdrop-blur-md p-4 rounded-3xl shadow-xl border-b-4 border-pink-500 flex items-center gap-4">
                <div id="user-pfp" class="w-12 h-12 bg-gradient-to-tr from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-black text-xl shadow-inner">?</div>
                <div>
                    <h1 id="display-name" class="font-black text-gray-800 leading-none text-base md:text-xl tracking-tighter uppercase">Employee</h1>
                    <div class="flex gap-2 items-center mt-1">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest"><span class="w-1.5 h-1.5 bg-green-500 rounded-full inline-block mr-1 animate-pulse"></span> ONLINE</p>
                        <button onclick="logout()" class="text-[9px] font-black text-red-500 uppercase hover:underline transition">Logout üö™</button>
                    </div>
                    <button id="admin-btn" onclick="toggleAdminPanel(true)" class="hidden mt-2 text-[9px] bg-red-100 text-red-600 font-black px-3 py-1 rounded-full uppercase tracking-widest hover:bg-red-200 transition">Admin Tools</button>
                </div>
            </div>

            <div class="flex flex-col gap-3 items-end">
                <div class="card interactive bg-white/95 backdrop-blur-lg p-5 rounded-[2rem] shadow-2xl w-72 border border-white">
                    <p class="text-[10px] font-black text-gray-400 mb-3 uppercase tracking-widest flex justify-between items-center">
                        Recipients <span id="recipient-count" class="bg-pink-100 text-pink-600 px-2 rounded-full">All</span>
                    </p>
                    <div id="target-list" class="max-h-32 overflow-y-auto flex flex-col gap-1.5 border-b pb-3 mb-3 custom-scrollbar px-1">
                        <label class="flex items-center gap-2 text-xs font-black cursor-pointer bg-blue-50/50 p-2 rounded-xl border border-blue-100">
                            <input type="checkbox" id="select-all-targets" checked class="w-4 h-4 rounded text-pink-500"> Everyone üåà
                        </label>
                    </div>
                    <textarea id="wish-text" rows="2" placeholder="Type a custom wish..." class="w-full p-3 bg-gray-50 border border-gray-100 rounded-2xl text-xs outline-none mb-3 font-semibold resize-none focus:border-pink-300 transition"></textarea>
                    <button onclick="sendAction()" class="w-full py-3 bg-gradient-to-r from-pink-500 to-orange-500 text-white rounded-2xl font-black text-xs hover:opacity-90 shadow-lg uppercase tracking-wider">Splash & Send Wish! ‚ú®</button>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="clearMyBoard('wishes')" class="interactive clear-btn px-5 py-2 rounded-full text-[10px] font-black uppercase tracking-widest text-orange-600 flex items-center gap-2">
                        <span>‚ú®</span> WISHES
                    </button>
                    <button onclick="clearMyBoard('colors')" class="interactive clear-btn px-5 py-2 rounded-full text-[10px] font-black uppercase tracking-widest text-blue-600 flex items-center gap-2">
                        <span>üé®</span> COLORS
                    </button>
                    <button onclick="clearMyBoard('all')" class="interactive clear-btn px-5 py-2 rounded-full text-[10px] font-black uppercase tracking-widest text-red-500 flex items-center gap-2">
                        <span>üóëÔ∏è</span> ALL
                    </button>
                </div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 items-center justify-between interactive">
            <div class="bg-white/95 backdrop-blur-md p-3 rounded-[2rem] shadow-2xl flex gap-2 overflow-x-auto max-w-md no-scrollbar border border-white" id="palette"></div>
            <div class="flex flex-wrap gap-2 justify-center bg-black/90 p-3 rounded-[2rem] shadow-2xl">
                <button onclick="setMode('splash')" id="btn-splash" class="mode-btn active px-6 py-3 rounded-full font-black text-[10px] uppercase bg-gray-800 text-gray-400 transition-all">Splash</button>
                <button onclick="setMode('pichkari')" id="btn-pichkari" class="mode-btn px-6 py-3 rounded-full font-black text-[10px] uppercase bg-gray-800 text-gray-400 transition-all">Pichkari</button>
                <button onclick="setMode('blast')" id="btn-blast" class="mode-btn px-6 py-3 rounded-full font-black text-[10px] uppercase bg-gray-800 text-gray-400 transition-all">Blast</button>
                <button onclick="setMode('egg')" id="btn-egg" class="mode-btn px-6 py-3 rounded-full font-black text-[10px] uppercase bg-gray-800 text-gray-400 transition-all">Egg Blast</button>
                <button onclick="triggerMegaBlast()" class="px-4 py-3 rounded-full font-black bg-white text-black hover:scale-110 active:scale-95 transition-all uppercase tracking-widest">MEGA BLAST üí•</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, where, getDocs, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { 
                apiKey: "AIzaSyAdMxwRFRffwyq6y2V5BywHqyU2_ykcfHo", 
                authDomain: "holi-86266.firebaseapp.com", 
                projectId: "holi-86266", 
                storageBucket: "holi-86266.firebasestorage.app", 
                messagingSenderId: "878132234023", 
                appId: "1:878132234023:web:d6d01419f44f621ed60b02" 
            };

        // USER EMAILJS CREDENTIALS
        const EMAILJS_SERVICE_ID = "bservice_ldrohn4";
        const EMAILJS_TEMPLATE_ID = "template_pvt74d4";
        const EMAILJS_PUBLIC_KEY = "RpZpsuRQYOT780rwI";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : "holi-final-v3";
        const ADMIN_EMAIL = "prudhvireddy882@gmail.com";
        const HOLI_COLORS = ['#FF1493', '#FF4500', '#FFD700', '#32CD32', '#00BFFF', '#8A2BE2', '#FF6347', '#00FA9A', '#FFFF00', '#FF00FF', '#FFFACD', '#FFFFFF', '#00CED1'];

        const canvas = document.getElementById('holiCanvas');
        const ctx = canvas.getContext('2d');
        const targetListDiv = document.getElementById('target-list');
        const wishInput = document.getElementById('wish-text');
        
        let particles = [];
        let interactionMode = 'splash';
        let isDrawing = false;
        let currentColor = '#FF1493';
        let currentUser = null;
        let employees = [];
        let activeActivities = [];
        let pendingUser = null;

        // Initialize EmailJS
        if (typeof emailjs !== 'undefined') emailjs.init(EMAILJS_PUBLIC_KEY);

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                } else { await signInAnonymously(auth); }
            } catch (err) { await signInAnonymously(auth); }
        };
        initAuth();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const empCol = collection(db, 'artifacts', APP_ID, 'public', 'data', 'employees');
                onSnapshot(empCol, (snapshot) => {
                    employees = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    updateTargetUI();
                    updateAdminList();
                });
            }
        });

        // Stage 1: Verify Email and Generate Code
        document.getElementById('email-form').onsubmit = async (e) => {
            e.preventDefault();
            const emailInput = document.getElementById('user-email');
            const email = emailInput.value.toLowerCase().trim();
            const found = employees.find(emp => emp.email === email) || (email === ADMIN_EMAIL ? { name: "Prudhvi (Admin)", email: ADMIN_EMAIL, gender: "male" } : null);

            if (found) {
                pendingUser = found;
                const code = Math.floor(100000 + Math.random() * 900000).toString();
                const id = email.replace(/[^a-zA-Z0-9]/g, '_');
                const userDoc = doc(db, 'artifacts', APP_ID, 'public', 'data', 'employees', id);
                
                try {
                    await setDoc(userDoc, { ...found, currentPasscode: code, lastPasscodeAt: serverTimestamp() }, { merge: true });
                    
                    // Trigger real email delivery via EmailJS
                    sendPasscodeToEmail(email, found.name, code);
                    
                    document.getElementById('target-email-display').innerText = email;
                    document.getElementById('login-stage-email').style.display = 'none';
                    document.getElementById('login-stage-passcode').style.display = 'block';
                } catch (err) { console.error("Firestore error:", err); }
            } else {
                document.getElementById('email-error').classList.remove('hidden');
                setTimeout(() => document.getElementById('email-error').classList.add('hidden'), 5000);
            }
        };

        // Stage 2: Login Verification
        document.getElementById('passcode-form').onsubmit = (e) => {
            e.preventDefault();
            const entered = document.getElementById('user-passcode').value;
            const userInList = employees.find(emp => emp.email === pendingUser.email);
            
            if ((userInList && userInList.currentPasscode === entered) || (pendingUser.email === ADMIN_EMAIL && entered === "123456")) {
                loginSuccess(userInList || pendingUser);
            } else {
                document.getElementById('passcode-error').classList.remove('hidden');
            }
        };

        function sendPasscodeToEmail(email, name, code) {
            const box = document.getElementById('notification-box');
            document.getElementById('notif-name').innerText = name.split(' ')[0];
            document.getElementById('notif-code').innerText = code;
            box.style.display = 'block';

            // Real EmailJS delivery
            if (typeof emailjs !== 'undefined') {
                emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                    to_email: email,
                    to_name: name,
                    passcode: code
                }).then(
                    (response) => { console.log('EMAIL SUCCESS!', response.status, response.text); },
                    (error) => { console.warn('EMAIL FAILED...', error); }
                );
            }
        }

        function loginSuccess(found) {
            currentUser = found;
            document.getElementById('display-name').innerText = found.name;
            document.getElementById('user-pfp').innerText = found.name[0];
            if (found.email === ADMIN_EMAIL) document.getElementById('admin-btn').classList.remove('hidden');
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('notification-box').style.display = 'none';
            initCanvas();
            startListeningToActivities();
        }

        window.logout = async () => {
            await signOut(auth);
            window.location.reload();
        };

        window.resetToEmail = () => {
            document.getElementById('login-stage-passcode').style.display = 'none';
            document.getElementById('login-stage-email').style.display = 'block';
        };

        // Real-time Activities
        function startListeningToActivities() {
            if (!currentUser || !auth.currentUser) return;
            const activityCol = collection(db, 'artifacts', APP_ID, 'public', 'data', 'activities');
            onSnapshot(activityCol, (snapshot) => {
                const incoming = snapshot.docs.map(d => ({id: d.id, ...d.data()}))
                                .filter(d => d.toEmail === currentUser.email || d.toEmail === 'Everyone');
                
                if (incoming.length < activeActivities.length) {
                    activeActivities = incoming;
                    clearAndRedraw();
                } else {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === "added") {
                            const data = change.doc.data();
                            if (data.toEmail === currentUser.email || data.toEmail === 'Everyone') {
                                renderActivity(data);
                            }
                        }
                    });
                    activeActivities = incoming;
                }
            });
        }

        function renderActivity(data) {
            if (data.type === 'mega-blast') {
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height;
                        const rc = HOLI_COLORS[Math.floor(Math.random() * HOLI_COLORS.length)];
                        createSplashEffect(x, y, rc, 75, 'blast');
                    }, i * 120);
                }
                return;
            }
            const x = data.x || Math.random() * canvas.width;
            const y = data.y || Math.random() * canvas.height;
            if (data.type === 'wish') showWishPopup(data.fromName, data.wishText, data.color);
            if (data.type === 'blast') {
                for(let j=0; j<4; j++) {
                    const rc = HOLI_COLORS[Math.floor(Math.random() * HOLI_COLORS.length)];
                    createSplashEffect(x, y, rc, 35, 'blast');
                }
            } else {
                createSplashEffect(x, y, data.color, (data.type === 'egg' ? 80 : 40), data.type);
            }
        }

        function showWishPopup(from, text, color) {
            const div = document.createElement('div');
            div.className = 'wish-popup';
            div.style.borderColor = color;
            div.style.left = (Math.random() * 50 + 20) + '%';
            div.style.top = (Math.random() * 50 + 20) + '%';
            div.innerHTML = `<div class="text-[9px] font-black uppercase text-gray-400">Wish from ${from}</div><div class="text-xs font-bold mt-1">${text}</div>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 6000);
        }

        function clearAndRedraw() {
            ctx.fillStyle = '#fdfdfd';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            activeActivities.forEach(renderActivity);
        }

        window.triggerMegaBlast = async () => {
            if (!currentUser || !auth.currentUser) return;
            const targets = document.getElementById('select-all-targets').checked ? ['Everyone'] : Array.from(document.querySelectorAll('.target-checkbox:checked')).map(cb => cb.value);
            for (const t of targets) {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'activities'), {
                    fromName: currentUser.name, fromEmail: currentUser.email, toEmail: t, type: 'mega-blast', color: currentColor, timestamp: serverTimestamp()
                });
            }
        };

        window.sendAction = async () => {
            if (!currentUser || !auth.currentUser) return;
            const wish = wishInput.value.trim() || "Bura na mano, Holi hai! üåà‚ú®";
            const targets = document.getElementById('select-all-targets').checked ? ['Everyone'] : Array.from(document.querySelectorAll('.target-checkbox:checked')).map(cb => cb.value);
            for (const t of targets) {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'activities'), {
                    fromName: currentUser.name, fromEmail: currentUser.email, toEmail: t, type: interactionMode === 'splash' ? 'wish' : interactionMode,
                    wishText: wish, color: currentColor, x: Math.random() * canvas.width, y: Math.random() * canvas.height, timestamp: serverTimestamp()
                });
            }
            wishInput.value = "";
        };

        window.clearMyBoard = async (mode) => {
            if (!currentUser || !auth.currentUser) return;
            const col = collection(db, 'artifacts', APP_ID, 'public', 'data', 'activities');
            const snapshot = await getDocs(col);
            const deletePromises = [];
            
            snapshot.docs.forEach(d => {
                const data = d.data();
                if (data.toEmail === currentUser.email || data.toEmail === 'Everyone') {
                    let shouldDelete = false;
                    if (mode === 'all') shouldDelete = true;
                    else if (mode === 'wishes' && data.type === 'wish') shouldDelete = true;
                    else if (mode === 'colors' && data.type !== 'wish') shouldDelete = true;
                    if (shouldDelete) deletePromises.push(deleteDoc(d.ref));
                }
            });
            if (deletePromises.length > 0) await Promise.all(deletePromises);
        };

        window.handleBulkImport = async () => {
            const ta = document.getElementById('bulk-import-text');
            const lines = ta.value.trim().split('\n');
            let count = 0;
            for (let line of lines) {
                const p = line.split(/[,\t]/).map(s => s.trim());
                if (p.length >= 2) {
                    const id = p[1].toLowerCase().replace(/[^a-zA-Z0-9]/g, '_');
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'employees', id), { name: p[0], email: p[1].toLowerCase(), gender: p[2] || 'male' });
                    count++;
                }
            }
            ta.value = "";
            document.getElementById('import-status').innerText = `ADDED ${count} MEMBERS.`;
            document.getElementById('import-status').classList.remove('hidden');
        };

        document.getElementById('admin-add-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('new-email').value.toLowerCase();
            const id = email.replace(/[^a-zA-Z0-9]/g, '_');
            await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'employees', id), { name: document.getElementById('new-name').value, email: email, gender: document.getElementById('new-gender').value });
            e.target.reset();
        };

        window.deleteEmployee = async (id) => await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'employees', id));

        function updateAdminList() {
            document.getElementById('employee-list-admin').innerHTML = employees.map(emp => `
                <div class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-2xl shadow-sm text-[10px] font-black uppercase tracking-tight">
                    <div>${emp.name} <span class="text-[8px] text-gray-400 lowercase font-bold">(${emp.email})</span></div>
                    <button onclick="deleteEmployee('${emp.id}')" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded-lg transition">Remove</button>
                </div>
            `).join('');
        }

        function updateTargetUI() {
            const selectAll = document.getElementById('select-all-targets')?.checked;
            targetListDiv.innerHTML = `<label class="flex items-center gap-2 text-xs font-black cursor-pointer bg-blue-50/50 p-2 rounded-xl border border-blue-100"><input type="checkbox" id="select-all-targets" ${selectAll ? 'checked' : ''}> Everyone üåà</label>`;
            employees.forEach(emp => {
                if (currentUser && emp.email === currentUser.email) return;
                const div = document.createElement('label');
                div.className = "flex items-center gap-2 text-[10px] font-bold py-2 border-b border-gray-50 hover:bg-gray-50 transition px-1";
                div.innerHTML = `<input type="checkbox" class="target-checkbox" value="${emp.email}"> ${emp.name}`;
                targetListDiv.appendChild(div);
            });
        }

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.fillStyle = '#fdfdfd';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const palette = document.getElementById('palette');
            palette.innerHTML = '';
            HOLI_COLORS.forEach(color => {
                const div = document.createElement('div');
                div.className = `color-swatch flex-shrink-0 ${color === currentColor ? 'active-color' : ''}`;
                div.style.backgroundColor = color;
                div.onclick = () => { currentColor = color; document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active-color')); div.classList.add('active-color'); };
                palette.appendChild(div);
            });
            animate();
        }

        class Particle {
            constructor(x, y, color, size, vx, vy, type) {
                this.x = x; this.y = y; this.color = color; this.size = size;
                this.vx = vx; this.vy = vy; this.alpha = 1;
                this.decay = type === 'egg' ? 0.005 : 0.012;
                this.gravity = type === 'pichkari' ? 0.04 : 0.12;
            }
            draw() { ctx.save(); ctx.globalAlpha = this.alpha; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); ctx.restore(); }
            update() { this.x += this.vx; this.y += this.vy; this.vy += this.gravity; this.alpha -= this.decay; if (this.alpha <= 0.05) { ctx.save(); ctx.globalAlpha = 0.2; ctx.beginPath(); ctx.arc(this.x, this.y, this.size * 2.2, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); ctx.restore(); } }
        }

        function createSplashEffect(x, y, color, density, type) {
            let fc = (type === 'egg') ? (Math.random() > 0.5 ? '#FFFACD' : '#FFFFFF') : color;
            for (let i = 0; i < density; i++) {
                const s = Math.random() * (type === 'egg' ? 14 : 9) + 2;
                const a = Math.random() * Math.PI * 2;
                const sp = Math.random() * (type === 'blast' ? 15 : 10) + 2;
                particles.push(new Particle(x, y, fc, s, Math.cos(a)*sp, Math.sin(a)*sp-2, type));
            }
            document.body.classList.add('vibrate'); setTimeout(() => document.body.classList.remove('vibrate'), 120);
        }

        function animate() { particles.forEach((p, i) => { p.update(); p.draw(); if (p.alpha <= 0) particles.splice(i, 1); }); requestAnimationFrame(animate); }

        window.setMode = (m) => { interactionMode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-' + m).classList.add('active'); };
        window.toggleAdminPanel = (s) => document.getElementById('admin-overlay').style.display = s ? 'flex' : 'none';
        
        window.onmousemove = (e) => {
            if (!currentUser) return;
            if (isDrawing && interactionMode === 'pichkari') {
                createSplashEffect(e.clientX, e.clientY, currentColor, 4, 'pichkari');
            }
        };

        window.onmousedown = (e) => { 
            if (e.target.tagName === 'CANVAS') { 
                isDrawing = true; 
                if (interactionMode !== 'pichkari') {
                    if (interactionMode === 'blast') {
                        for(let j=0; j<4; j++) {
                            const rc = HOLI_COLORS[Math.floor(Math.random() * HOLI_COLORS.length)];
                            createSplashEffect(e.clientX, e.clientY, rc, 35, 'blast');
                        }
                    } else {
                        createSplashEffect(e.clientX, e.clientY, currentColor, 45, interactionMode);
                    }
                }
            } 
        };
        window.onmouseup = () => isDrawing = false;
        window.onresize = initCanvas;
    </script>
</body>
</html>
